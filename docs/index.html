<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Onboard Player</title>
  <!-- Load Ethers.js (UMD build) -->
  <script src="https://hari-hari-dev.github.io/Grens/ethers-5.2.umd.min.js"></script>
</head>
<body>
  <h1>Onboard Player to DApp</h1>

  <button id="connectButton">Connect Wallet</button>
  <p id="walletStatus">Not connected</p>

  <hr />

  <label for="playerName">Player Name:</label>
  <input type="text" id="playerName" placeholder="Enter your desired name" />
  <button id="onboardButton">Onboard</button>

  <p id="onboardStatus"></p>

  <hr />

  <h2>Your Grens Balance</h2>
  <p id="balanceDisplay">Loading...</p>
  <button id="refreshBalanceButton">Refresh Balance</button>

  <script>
    /************************************************************
     *  Contract Addresses / ABIs
     ************************************************************/
    const DAPP_CONTRACT_ADDRESS = "0xBd886d5E326d101Da3035E49F78c83d80dfFB4b2";
    // Minimal ABI for your function:
    const DAPP_CONTRACT_ABI = [
      "function onboardPlayerGated(string calldata _playerName) external"
    ];

    // The ERC20 "Grens" token contract
    const GRENS_CONTRACT_ADDRESS = "0x31e4f69cb2045314D9f9cD1cBA1A2137cB258dE3";
    // Standard ERC20 ABI subset for balanceOf & decimals
    const GRENS_CONTRACT_ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];

    /************************************************************
     *  Global vars for Ethers
     ************************************************************/
    let provider;
    let signer;
    let dappContract;
    let grensContract;
    let userAddress = null;

    /************************************************************
     *  On page load, set up button event listeners
     ************************************************************/
    window.addEventListener('load', function () {
      const connectButton = document.getElementById('connectButton');
      const onboardButton = document.getElementById('onboardButton');
      const refreshButton = document.getElementById('refreshBalanceButton');

      connectButton.onclick = connectWallet;
      onboardButton.onclick = onboardPlayer;
      refreshButton.onclick = refreshBalance;
    });

    /************************************************************
     *  (A) pickMetaMaskProvider => ensure we use MetaMask only
     ************************************************************/
    async function pickMetaMaskProvider() {
      // If no EVM provider at all:
      if (!window.ethereum) {
        return null;
      }

      // If multiple providers exist:
      if (window.ethereum.providers?.length) {
        // find the one with isMetaMask
        const metaMask = window.ethereum.providers.find((p) => p.isMetaMask);
        if (metaMask) return metaMask;
      }

      // If there's only one provider or no .providers array, check if it's MetaMask
      if (window.ethereum.isMetaMask) {
        return window.ethereum;
      }

      // Otherwise, no metamask
      return null;
    }

    /************************************************************
     *  1) Connect to MetaMask only
     ************************************************************/
    async function connectWallet() {
      if (!window.ethereum) {
        alert("No EVM provider found. Please install MetaMask.");
        return;
      }

      try {
        const metaMaskProvider = await pickMetaMaskProvider();
        if (!metaMaskProvider) {
          alert("MetaMask not found or Phantom is overriding. Please disable Phantom or ensure isMetaMask is present.");
          return;
        }

        // Request accounts from the chosen MetaMask provider
        await metaMaskProvider.request({ method: 'eth_requestAccounts' });

        // Wrap in Ethers.js
        provider = new ethers.providers.Web3Provider(metaMaskProvider);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        document.getElementById('walletStatus').textContent =
          "Connected as " + userAddress;

        // Initialize contract instances
        dappContract = new ethers.Contract(DAPP_CONTRACT_ADDRESS, DAPP_CONTRACT_ABI, signer);
        grensContract = new ethers.Contract(GRENS_CONTRACT_ADDRESS, GRENS_CONTRACT_ABI, provider);

        // Optionally display initial balance
        await refreshBalance();
      } catch (err) {
        console.error(err);
        document.getElementById('walletStatus').textContent = "Connection failed: " + (err.message || err);
      }
    }

    /************************************************************
     *  2) Onboard Player
     ************************************************************/
    async function onboardPlayer() {
      if (!signer || !dappContract) {
        alert("Please connect your wallet first.");
        return;
      }
      const playerName = document.getElementById('playerName').value.trim();
      if (!playerName) {
        alert("Please enter a valid player name.");
        return;
      }

      const statusEl = document.getElementById('onboardStatus');
      statusEl.textContent = "Submitting transaction...";

      try {
        let tx = await dappContract.onboardPlayerGated(playerName);
        statusEl.textContent = "Waiting for confirmation (tx: " + tx.hash + ")...";
        let receipt = await tx.wait();  // Wait for block confirmation
        statusEl.textContent = "Success! Player onboarded. (block: " + receipt.blockNumber + ")";

        // Optionally refresh balance
        await refreshBalance();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + (err.message || err);
      }
    }

    /************************************************************
     *  3) Refresh Grens Token Balance
     ************************************************************/
    async function refreshBalance() {
      if (!userAddress || !grensContract) {
        document.getElementById('balanceDisplay').textContent = "Not connected.";
        return;
      }
      try {
        // 1) fetch raw balance
        let balanceBN = await grensContract.balanceOf(userAddress);

        // 2) fetch decimals from the contract
        let decimals = await grensContract.decimals();

        // 3) convert raw balance to a decimal string
        let balanceStr = ethers.utils.formatUnits(balanceBN, decimals);

        document.getElementById('balanceDisplay').textContent =
          balanceStr + " GRENS";
      } catch (err) {
        console.error(err);
        document.getElementById('balanceDisplay').textContent =
          "Error fetching balance: " + (err.message || err);
      }
    }
  </script>
</body>
</html>
